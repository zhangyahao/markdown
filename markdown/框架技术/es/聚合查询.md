####  作用（个人向）  
    1.  可以把多个查询聚合起来一起查询是能力。
    2.  将一些不太容易或者不能一起写进查询条件中的查询条件作为聚合查询，来完成查询。





1.  `CardinalityAggregationBuilder` 基数统计，此聚合会去重查询  
    统计某个字段中的所有值  
    ```aidl
         public CardinalityAggregationBuilder getCount() {
                return AggregationBuilders.cardinality("count").field("xxx");
            }
    
         //设置查询
            CardinalityAggregationBuilder cusAdd = getCount();
             response = client.prepareSearch(index).setTypes(type)
                                     .setQuery(queryBuilder)
                                     .addAggregation(cardinalityAgg)
                                     .setExplain(true)
                                     .execute().actionGet();
             Cardinality cardinality= response.getAggregations().get("count");
             int value=cardinality.getValue();
    
     ```
2.  `agregationBuilder`    单条过滤聚合
    ```aidl
        public class EsFilterAgg throws UnknownHostException{
            public void FilterAgg(TransportClient client){
               QueryBuilder query = QueryBuilders.termQuery("age", 20);
               //把termQuery设的条件作为过滤条件
               AggregationBuilder agg = AggregationBuilders.filter("filter", query);
               
               SearchResponse response = client.prepareSearch("lib3")
        							       .addAggregation(agg)
        							       .execute()
        							       .actionGet();
        	   
        	   Filter filter = response.getAggregations().get("filter");
        	   System.out.println(filter.getDocCount());
            }
        }

    ```
        
2.  `FiltersAggregationBuilder` 多层聚合   
    聚合多个BoolQueryBuilder，获取结果  
    ```text
          BoolQueryBuilder  q1,q2,q3,q4;
          q1= QueryBuilders.boolQuery();
          q1.must(QueryBuilders.termsQuery("xxxx", "0", "3"));
          q2=QueryBuilders.boolQuery();
          q2.must(QueryBuilders.termQuery("xxxx", "10"));
           FiltersAggregationBuilder aggregationBuilder= AggregationBuilders.filters("filters",
                                                                        new FiltersAggregator.KeyedFilter("q1", q1),
                                                                        new FiltersAggregator.KeyedFilter("q2", q2)
                                                                    );
            //查询条件提交
           SearchResponse  response = client.prepareSearch(index).setTypes(type)
                                        .setFetchSource(showFields, null)
                                        .setQuery(baseQuery)
                                        .addAggregation(aggregationBuilder)
                                        .setExplain(true)
                                        .execute().actionGet();
           //获取查询结果
          Filters  filters = response.getAggregations().get("filters");
          for (Filters.Bucket bucket : filters.getBuckets()) {
                            info.put(bucket.getKeyAsString(), bucket.getDocCount());
                        }
    ```
3.  时间聚合  
    ```aidl     
           AggregationBuilder timeAgg = AggregationBuilders.dateRange("findTime")
                                                                        .field("findTime")
                                                                        .format("yyyy-MM-dd HH:mm:ss")
                                                                        .addUnboundedFrom(params.get("startTime"))
                                                                        .addRange(params.get("startTime"), params.get(
                                                                            "endTime"))
                                                                        .addUnboundedTo(params.get("endTime"));

    ```   
4.  `range`范围聚合 
    ```text
        Public class EsRangeAgg throws UnknownHostException{
            public void RangeAgg(TransportClient client){
               AggregationBuilder agg = AggregationBuilders.range("range")
        											       .field("age")
        											       .addUnboundedTo(50)    //( , to)
        											       .addRange(25, 50)      //[from, to) 
        											       .addUnboundedFrom(25); //[from,)
               
               SearchResponse response = client.prepareSearch(index).setTypes(type)
        							       .addAggregation(agg)
        							       .execute()
        							       .actionGet();
        	   
        	   Range r = response.getAggregations().get("range");
        	   for(Range.Bucket entity:filters.getBuckets){
        		   System.out.println(entry.getKey()+":"+entry.getDocument());
        	   }
            }
        }

    ```
5.  `missing`为空、为null聚合    
    ```text
        public class EsMissingAgg throws UnknownHostException{
            public void MissingAgg(TransportClient client){
               AggregationBuilder agg = AggregationBuilders.missing("missing")
        											       .field("price"); 
               
            }
        }

    ```