### 自定义函数格式
```sql
    DELIMITER 自定义符号
    CREATE FUNCTION 函数名(形参列表) RETURNS 返回类型--注意是RETURNS
    BEGIN
    函数体
    RETURN 结果值;
    END 自定义符号
    DELIMITER;
    自定义函数格
```
1. `DELIMITER` 使用时一般不用写。  
2. 形参列表一般为 `形参 类型`,类型为MySQL支持类型。例如：
    ```sql 
    create function diff(price float)
   ```
3. 函数返回的数据类型，必须为MySQL支持类型
4. 函数体：执行逻辑，变量定义、计算、条件判断等
5. 变量设置
    1. 定义用户变量 ： set@变量名=值；使用时用@变量名
    2. 定义局部变量 ： 在函数内部设置declare变量名;局部变量可以使用set赋值或者使用into关键字
    
6. 新版本中一般mysql会默认开启严格模式。正式环境一般开启。两种解决办法：
     1. **添加DETERMINISTIC声明** 声明函数是确定性的（相同输入→相同输出）
         ```sql
                create FUNCTION get_course(stu_name varchar(20))
                    returns varchar(20)
                    deterministic
                begin
                    declare course_name varchar(20);
                    select c.c_name
                    into course_name
                    from score s,
                         course c
                    where s.c_id = c.c_id
                      and s_id = (select student.s_id from student where s_name = stu_name);
                    return course_name;
                end;
     
         ```
     
     2. **NO SQL**：声明函数不包含SQL语句
           ```sql
                    create function add10(price float)
                        returns float
                        no sql
                    begin
                        declare new_price float;
                        set new_price = price + 10;
                        return new_price;
                    end;
           ```
7.  条件控制语句
    1. if :
        ```sql
           IF 条件 THEN
           语句;
           ELSEIF 条件 THEN
           语句;
           ELSE
           语句;
           END IF;
        ```
    2. case注意**end**必须写。两种方式 :
        ```sql
           CASE 变量/字段
           WHEN 常量值1 THEN
           结果值1;
           WHEN 常量值2 THEN
           结果值2;
           [ELSE
           默认值;]
           END
        ```
        ```sql
          CASE
          WHEN条件1THEN结果值1;
          WHEN条件2THEN结果值2;
          [ELSE
          默认值;]
          END
        ```
8. 其他操作
    1. 修改函数（仅支持修改注释、权限等，逻辑需重建）：
        ```sql
       ALTER FUNCTION 函数名 COMMENT '函数注释’;
       ```
    2. 查找/查看函数:
        ```sql
           SHOW FUNCTION STATUS where db='数据库名';
       --     或者
           SHOW FUNCTION STATUS WHERE Name = '函数名';
       --  或者   
           SHOW FUNCTION STATUS LIKE '函数名';
       -- 或者
           SELECT 
               ROUTINE_SCHEMA AS `数据库`,
               ROUTINE_NAME AS `函数名`,
               ROUTINE_TYPE AS `类型`,
               CREATED AS `创建时间`
           FROM INFORMATION_SCHEMA.ROUTINES
           WHERE ROUTINE_NAME = 'add10'
             AND ROUTINE_TYPE = 'FUNCTION';
        ```
    3. 删除函数：
        ```sql
           DROP FUNCTION 函数名
        ```
    4. 查看函数的定义:
       ```sql
        SHOW CREATE FUNCTION 函数名
       ```
###存储过程
```sql
DELIMITER 自定义符号
CREATE PROCEDURE 存储过程名(形参列表)
BEGIN
存储过程体 -- 可包含任意SQL（增删改查）、流程控制（IF/WHILE/LOOP）、变量定义 ，无强制RETURN，可通过OUT参数返回多个结果
END 自定义符号
DELIMITER;
```
1. 形参与自定义函数不同。一般为 `形参列表 ：[ IN | OUT | INOUT ] 形参名类型`。  
   in 输入，out 输出，inout 可以输入也可以输出
2. 调用：
  1. 无输出参数
     ```text
      CALL 过程名(参数);
     ```
  2. 有输出参数（需先定义变量接收）
     ```text
       SET @变量名 = 初始值;
       CALL 过程名(IN参数, OUT @变量名);
       SELECT @变量名; -- 查看输出结果
     ```
3. 函数体可包含增删改查、流程控制。支持事务
4. 示例：
    ```sql
       CREATE PROCEDURE stat_student_score(
       IN p_student_id INT, -- 输入：学生ID
       OUT p_total_score INT, -- 输出：总分
       OUT p_avg_score DECIMAL(5,2),-- 输出：平均分
       OUT p_course_count INT -- 输出：考试课程数 )
       BEGIN -- 统计总分、课程数
       SELECT SUM(score), COUNT(*), AVG(score)
       INTO p_total_score, p_course_count, p_avg_score -- 赋值到输出参数FROM score WHERE student_id = p_student_id;
       END; 
       -- 调用存储过程（统计张三的成绩）
       SET @total = 0;
       SET @avg = 0.0;
       SET @count = 0;
       CALL stat_student_score(1, @total, @avg, @count); -- 查看结果
       SELECT @total AS 总分, @avg AS 平均分, @count AS 考试课程数
   ```

