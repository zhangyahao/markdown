1. 改变
    1. 2.0的改变 <br>
        1. [es2.0的特性改变](http://www.searchtech.pro/articles/2015/12/24/1450960706545.html)
        2. [2.0在api上的改变](http://www.chepoo.com/elasticsearch-2-x-upgrade-experience.html)
    2. 5.0改变
        1. [具体改变](http://www.chepoo.com/elasticsearch-2-x-upgrade-experience.html) 
2. api 更改
    1. es连接
        ```aidl
        package com.ccdt.amos.cirs.search.base;
        
        import com.ccdt.amos.cirs.util.ConfigProperty;
        import org.elasticsearch.action.admin.indices.exists.indices.IndicesExistsRequest;
        import org.elasticsearch.action.admin.indices.exists.indices.IndicesExistsResponse;
        import org.elasticsearch.action.bulk.BulkRequestBuilder;
        import org.elasticsearch.action.bulk.BulkResponse;
        import org.elasticsearch.action.index.IndexRequestBuilder;
        import org.elasticsearch.action.search.SearchResponse;
        import org.elasticsearch.client.Client;
        import org.elasticsearch.client.transport.TransportClient;
        import org.elasticsearch.common.settings.Settings;
        import org.elasticsearch.common.transport.InetSocketTransportAddress;
        import org.elasticsearch.index.query.QueryBuilders;
        import org.elasticsearch.index.query.QueryStringQueryBuilder;
        import org.elasticsearch.search.SearchHit;
        import org.elasticsearch.search.SearchHits;
        import org.elasticsearch.transport.client.PreBuiltTransportClient;
        
        import java.net.InetAddress;
        import java.net.UnknownHostException;
        import java.util.HashSet;
        import java.util.List;
        import java.util.Map;
        
        /**
         * @program: amos-cirs
         * @description: elasticsearch  适用5+以上
         * @author: Zhang
         * @create: 2018-07-23 10:23
         **/
        public class NewEsUtil {
            private static String clusterName = ConfigProperty.getProps().getProperty("elasticsearch.cluster.name");
            private static String[] iPports = ConfigProperty.getProps().getProperty("elasticsearch.Hosts").split(":");
            private Client client = this.connectionEs();
        
            public  TransportClient connectionEs() {
                Settings settings = Settings.builder().put("cluster.name", clusterName)
                                            .put("client.transport.sniff", true)
                                            .build();
        
                /*//忽视连接集群时名字验证
                builder.put("client.transport.ignore_cluster_name", true);
                //ping 一个节点时等待时间 默认5秒
                builder.put("client.transport.ping_timeout", "5s");
                //多久采样 ping / 节点列表和连接
                builder.put("client.transport.nodes_sampler_interval", "5s");*/
        
                try {
                    //连接
                    TransportClient client = new PreBuiltTransportClient(settings)
                            .addTransportAddress(new InetSocketTransportAddress(InetAddress.getByName(iPports[0]), Integer.parseInt(iPports[1])));
                    return client;
                } catch (UnknownHostException e) {
                    e.printStackTrace();
                }
                return null;
            }
        
          
        }

        ```  
    2. 索引建立
        ```aidl
        TransportClient transportClient = getTransportClient(); 
            CreateIndexRequestBuilder createIndex=transportClient.admin().indices().prepareCreate(index);
                XContentBuilder mapping = XContentFactory.jsonBuilder()
                        .startObject()
                        .startObject("properties") //设置之定义字段
                        .startObject("name").field("type","text").field("analyzed","standard").endObject() //设置分析器
                        .startObject("name").field("type","text").field("analyzed","ik_max_word").endObject() //设置分析器
                        .startObject("age").field("type","long").endObject()
                        .startObject("class_name").field("type","keyword").endObject()
                        .startObject("birth").field("type","date").field("format","yyyy-MM-dd").endObject()//设置Date的格式
                        .endObject()
                        .endObject();
                createIndex.addMapping(type, mapping);
                CreateIndexResponse res=createIndex.execute().actionGet();
        ```    
    3.  数据写入相关
        1. 批量插入数据  `BulkRequestBuilder`
            ```aidl
            BulkRequestBuilder bulkRequest = transportClient.prepareBulk();
            for(Map source:sources){
               //添加请求
               bulkRequest.add(transportClient.prepareIndex(index,type)
                       .setSource(source));
               }
              BulkResponse bulkResponse = bulkRequest.execute().actionGet();
            }

           ```
        2.  单条写入
            ```aidl
            TransportClient client= ElasticSearchTestConfig.getTransportClient();
                Map<String, Object> map = new HashMap<String, Object>();
                map.put("name","张三");
                map.put("age",22);
                IndexRequestBuilder create = clien.prepareIndex("my","text")
                            .setSource(map);
                IndexResponse response = create.execute().actionGet();
    
            ```  
    4.  删除索引和文档数据           
        1. 删除索引
            ```aidl
            //先判断下索引是否存在
             IndicesExistsRequest inExistsRequest = new IndicesExistsRequest(index);
             IndicesExistsResponse inExistsResponse = client.admin().indices()
                            .exists(inExistsRequest).actionGet();
              //存在即进行删除操作
             if(inExistsResponse.isExists()){
                  DeleteIndexRequestBuilder delete = client.admin().indices().prepareDelete(index);
                  DeleteIndexResponse dResponse = delete.execute().actionGet();   

            ```
        2.  根据id删除数据    
            ```aidl
            DeleteRequestBuilder delete = client.prepareDelete("my","text","1");
                    DeleteResponse response = delete.execute().actionGet();
            ```
        3.  根据搜索返回值删除数据    
            ```aidl
                //Query  是一个QueryBuilder   例如 QueryBuilder Query= QueryBuilders.matchQuery("name", "葫芦4032娃");
                DeleteByQueryAction.INSTANCE.newRequestBuilder(client).filter(Query).execute();
            ```
    5. 查询相关  相比较 es1版本   取消了 `Filter` 已经可以不用
        1. QueryBuilder 相关
            1. 搜索全部<br>
                ```aidl
                   QueryBuilder matchAll = QueryBuilders.matchAllQuery();
                ```
            2. 字段值包含搜索    
                ```aidl
                QueryBuilder match = QueryBuilders.matchQuery("field","text");
               ```
            3.  字段值精确值匹配   
                ```aidl
                    QueryBuilder term = QueryBuilders.termQuery("field","text");
                    QueryBuilder terms = QueryBuilders.termsQuery("field","text","text2","text3");
               ```
            4.  前缀搜索   
                ```aidl
                    QueryBuilder prefix= QueryBuilders.prefixQuery("field","text");
                ```
            5.  通配符搜索    
                ```aidl
                QueryBuilder wildcard= QueryBuilders.wildcardQuery(field,patten);
               ```
            6.  搜索语句搜索   
                ```aidl     
                QueryBuilder queryString= QueryBuilders.queryStringQuery("queryString");
               ```
        1. matchAllQuery() <br>
            matchAllQuery()方法用来匹配全部文档  
           ```aidl
            QueryBuilder queryBuilder = QueryBuilders.matchAllQuery();
            SearchResponse searchResponse = es.searcher(indexName, typeName,
            ```
        2. matchQuery(String name,Object  text)<br>
            matchQuery("filedname","value")匹配单个字段，匹配字段名为filedname,值为value的文档
            ```aidl
            //单个匹配，搜索name为jack的文档
            QueryBuilder queryBuilder = QueryBuilders.matchQuery("name", "jack");
            ```
        3.  multiMatchQuery(Object text, String... fieldNames)    <br>
             多个字段匹配某一个值
             ```aidl
              QueryBuilder queryBuilder = QueryBuilders.multiMatchQuery("music",
                         "name", "interest");//搜索name中或interest中包含有music的文档（必须与music一致）
            ```
        4.  wildcardQuery()  or FuzzyQueryBuilder <br>
            模糊查询     模糊查询，?匹配单个字符，*匹配多个字符
            ```aidl
            WildcardQueryBuilder queryBuilder = QueryBuilders.wildcardQuery("name",
                        "*jack*");//搜索名字中含有jack文档（name中只要包含jack即可）
            FuzzyQueryBuilder fuzzy= QueryBuilders.fuzzyQuery("name", "*jack*");
           ```
        5. BoolQueryBuilder()<br>   
            复合查询  可使用 `must` `should` `mustnot`
            ```aidl
            
               WildcardQueryBuilder queryBuilder1 = QueryBuilders.wildcardQuery(
                           "name", "*jack*");//搜索名字中含有jack的文档
               WildcardQueryBuilder queryBuilder2 = QueryBuilders.wildcardQuery(
                           "interest", "*read*");//搜索interest中含有read的文档
                
               BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery();
               //name中含有jack或者interest含有read，相当于or
               boolQueryBuilder.should(queryBuilder1);
               boolQueryBuilder.should(queryBuilder2)
               //name中必须含有jack,interest中必须含有read,相当于and
               boolQueryBuilder.must(queryBuilder1);
               boolQueryBuilder.must(queryBuilder2)

            ```
        6.  Aggregation<br>     
            聚合搜索  聚合相当于SQL中的group by，使用不同的AggregationBuilder能完成不同的聚合操作
            ，以及对不同的数据进行运算排序
            [具体操作](https://elasticsearch.cn/article/102)
        7.  boosting query<br>   
            权重过滤
            ```aidl
                BoolQueryBuilder builder = QueryBuilders.boolQuery();
                TermQueryBuilder tqbA = QueryBuilders.termQuery("fieldA", "A").boost(5.0f);
                TermQueryBuilder tqbB = QueryBuilders.termQuery("fieldB", "B").boost(2.0f);
                TermQueryBuilder tqbC = QueryBuilders.termQuery("fieldC", "C").boost(0.2f);
            ```
    6. 查询执行        
        1.  当只需要提交查询条件时       
               ```aidl
                   SearchRequestBuilder requestBuilder = client.prepareSearch(index).setTypes(type);
                   requestBuilder.setQuery(builder);
                   SearchResponse response = requestBuilder.execute().actionGet();
                    //或者写在一起
                     SearchResponse response =client.prepareSearch(index).setTypes(type)
                                                                         .setQuery(builder)
                                                                         .setExplain(true).execute().actionGet();
       
               ```
        2.  当需要对查询结果进行一定的策略整理时        
            ```aidl
                	SearchResponse response = client.prepareSearch("b").setTypes("yyt")
                                       		                            //搜索的关键字
                                       									.setQuery(qb)
                                       									//每次搜索的范围
                                       									.setFrom(0).setSize(10000)
                                       									//查询匹配的字段 第一参数为包含  第二个为排除
                                       								    .setFetchSource("mzName", null)
                             								            //使用min聚合查询某个字段上最小的值。
                             								            .addAggregation(AggregationBuilders.min("min").field("age"))
                                       								    //设置最小的匹配度
                                       								    .minimumShouldMatch("100%")
                                       								    //设置过滤
                                       								    .setPostFilter(FilterBuilders.rangeFilter("age").from(12).to(18))
                             								            //排序   .missing("_last"))不能应用于布尔值的索引
                   								                        .addSort(new FieldSortBuilder("id").order(SortOrder.DESC).missing("_last"))
                	                                                     //或者这样排序
                	                                                    .addSort("id",SortOrder.DESC)
                                                                          //或者
                                                                        .addSort(SortBuilders.fieldSort("id").order(SortOrder.DESC))    
                                       								    //查询全部
                                       								    .setExplain(true)
                                       								    .execute().actionGet(); 

            ```
    7.  查询结果分析        
        ```aidl
               SearchHits hits = searchResponse.getHits();
                    SearchHit[] searchHits = hits.getHits();
                    int i = 0;
                    for (SearchHit searchHit : searchHits) {
                        String name = (String) searchHit.getSource().get("name");
                        String birth = (String) searchHit.getSource().get("birth");
                        String interest = (String) searchHit.getSource().get("interest");
                        System.out.println("-------------" + (++i) + "------------");
                        System.out.println(name);
                        System.out.println(birth);
                        System.out.println(interest);
                    }

        ```
4. 其它详解
    [地址](https://www.felayman.com/articles/2017/11/20/1511170141414.html)            